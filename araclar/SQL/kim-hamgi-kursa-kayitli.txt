SELECT 
    u.id,
    u.username,
    u.firstname,
    u.lastname,
    u.email,
    c.fullname AS course_name,
    r.name AS role_name,
    FROM_UNIXTIME(ue.timestart) AS enrolment_date

FROM 
    {user} u                          -- Kullanıcı Bilgileri

JOIN 
    {user_enrolments} ue ON ue.userid = u.id   -- Kullanıcı Kayıtları

JOIN 
    {enrol} e ON e.id = ue.enrolid             -- Kayıt Yöntemi

JOIN 
    {course} c ON c.id = e.courseid            -- Kurs Bilgileri

LEFT JOIN 
    {context} ctx 
        ON ctx.instanceid = c.id 
        AND ctx.contextlevel = 50              -- Kurs Bağlamı (Course context)

LEFT JOIN 
    {role_assignments} ra 
        ON ra.userid = u.id 
        AND ra.contextid = ctx.id              -- Rol Atamaları

LEFT JOIN 
    {role} r 
        ON r.id = ra.roleid                    -- Rol Adı

WHERE 
    u.deleted = 0 
    AND c.id <> 1

ORDER BY 
    c.fullname,
    u.lastname
